{{- $context := .Context -}}
{{- $limit := default 10 .Params.limit -}}

{{/* 계층 구조 데이터 생성 */}}
{{- $hierarchical := dict -}}

{{/* 모든 포스트를 순회하며 메인/서브 카테고리 추출 */}}
{{- range $context.Site.RegularPages -}}
    {{- if .Params.categories -}}
        {{- if ge (len .Params.categories) 2 -}}
            {{- $main := index .Params.categories 0 -}}
            {{- $sub := index .Params.categories 1 -}}

            {{/* 메인 카테고리 초기화 */}}
            {{- if not (index $hierarchical $main) -}}
                {{- $hierarchical = merge $hierarchical (dict $main (dict "count" 0 "subs" dict)) -}}
            {{- end -}}

            {{/* 메인 카테고리 포스트 수 증가 */}}
            {{- $mainData := index $hierarchical $main -}}
            {{- $newCount := add $mainData.count 1 -}}
            {{- $mainData = merge $mainData (dict "count" $newCount) -}}

            {{/* 서브 카테고리 초기화 및 카운트 */}}
            {{- $subs := $mainData.subs -}}
            {{- $subCount := default 0 (index $subs $sub) -}}
            {{- $subs = merge $subs (dict $sub (add $subCount 1)) -}}
            {{- $mainData = merge $mainData (dict "subs" $subs) -}}

            {{- $hierarchical = merge $hierarchical (dict $main $mainData) -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

<section class="widget tagCloud">
    <div class="widget-icon">
        {{ partial "helper/icon" "categories" }}
    </div>
    <h2 class="widget-title section-title">{{ T "widget.categoriesCloud.title" }}</h2>

    <div class="hierarchical-categories">
        {{/* 메인 카테고리를 포스트 수 기준으로 정렬 */}}
        {{- range $mainCat, $data := $hierarchical -}}
            <div class="main-category">
                <a href="/categories/{{ $mainCat | urlize }}/" class="font_size_{{ $data.count }}">
                    <strong>{{ $mainCat }}</strong> ({{ $data.count }})
                </a>

                {{/* 서브 카테고리 표시 */}}
                {{- if $data.subs -}}
                    <div class="sub-categories">
                        {{- range $subCat, $subCount := $data.subs -}}
                            <a href="/categories/{{ $subCat | urlize }}/" class="sub-category">
                                ├─ {{ $subCat }} ({{ $subCount }})
                            </a>
                        {{- end -}}
                    </div>
                {{- end -}}
            </div>
        {{- end -}}
    </div>
</section>

<style>
.hierarchical-categories {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.main-category {
    display: flex;
    flex-direction: column;
}

.main-category > a {
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.sub-categories {
    display: flex;
    flex-direction: column;
    padding-left: 1rem;
    gap: 0.25rem;
}

.sub-category {
    font-size: 0.9em;
    color: var(--card-text-color-secondary);
}
</style>
